# Docker Setup for API Client Generation

## Overview

The frontend Docker container automatically generates the React Query API client from the backend's OpenAPI specification on startup.

## How It Works

### Startup Flow

1. **Backend Container Starts**
   - NestJS backend starts
   - OpenAPI spec is available at `/app/openapi.json`
   - Health check confirms backend is ready

2. **Frontend Container Starts**
   - Waits for backend to be healthy
   - Mounts backend's `openapi.json` file
   - Runs `frontend/start.sh` script

3. **API Generation** (`frontend/start.sh`)
   - Detects OpenAPI spec location
   - Runs `npm run generate:api`
   - Generates React Query hooks and TypeScript types
   - Starts Vite dev server

### File Structure in Docker

```
Frontend Container:
/app/
â”œâ”€â”€ backend-openapi.json   # Mounted from backend container
â”œâ”€â”€ src/
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ axios-instance.ts
â”‚       â”œâ”€â”€ generated/      # Generated by orval on startup
â”‚       â”‚   â”œâ”€â”€ contracts/
â”‚       â”‚   â”œâ”€â”€ default/
â”‚       â”‚   â””â”€â”€ model/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ orval.config.ts         # Auto-detects Docker vs local paths
â”œâ”€â”€ start.sh                # Startup script with API generation
â””â”€â”€ ...
```

## Configuration Files

### `docker-compose.yml`

```yaml
frontend:
  build:
    context: ./frontend
    dockerfile: Dockerfile
  volumes:
    # Mount backend OpenAPI spec
    - ./backend/openapi.json:/app/backend-openapi.json:ro
  depends_on:
    backend:
      condition: service_healthy  # Wait for backend to be ready
```

### `frontend/orval.config.ts`

Automatically detects the environment and uses the appropriate OpenAPI spec path:

```typescript
const getOpenApiPath = () => {
  const dockerPath = "/app/backend-openapi.json";    // In Docker
  const localPath = "../backend/openapi.json";       // Local dev
  
  if (fs.existsSync(dockerPath)) {
    return dockerPath;
  }
  return localPath;
};
```

### `frontend/start.sh`

```bash
#!/bin/sh
# 1. Check for OpenAPI spec
# 2. Generate API client
# 3. Start Vite dev server
```

## Advantages

âœ… **Always Fresh** - API client regenerates on every container startup  
âœ… **No Manual Steps** - Fully automated in Docker environment  
âœ… **Type Safety** - Frontend always matches backend API  
âœ… **Development Speed** - Developers just run `docker-compose up`  
âœ… **CI/CD Ready** - Works in automated deployment pipelines  

## Local Development

For local development without Docker:

```bash
# Terminal 1: Backend
cd backend
npm run generate:openapi  # Generate OpenAPI spec
npm run start:dev

# Terminal 2: Frontend
cd frontend
npm run generate:api      # Generate client manually
npm run dev
```

## Troubleshooting

### API client not generated

Check the frontend container logs:
```bash
docker logs ai-contracts-frontend
```

Look for:
```
ðŸ“¡ Generating API client from OpenAPI spec at: /app/backend-openapi.json
âœ… API client generated successfully!
```

### OpenAPI spec not found

Ensure:
1. Backend has generated the spec: `backend/openapi.json` exists
2. Frontend volume mount is configured in `docker-compose.yml`
3. Backend container is healthy before frontend starts

### Type errors in frontend

```bash
# Rebuild containers to regenerate with latest API
docker-compose down
docker-compose up --build
```

## When Backend API Changes

When you modify the backend API:

1. **In Docker**: Just restart containers
   ```bash
   docker-compose restart
   ```

2. **Locally**: Regenerate manually
   ```bash
   cd backend && npm run generate:openapi
   cd ../frontend && npm run generate:api
   ```

The generated client will automatically update with new endpoints, types, and changes.
