# Orval Setup - Auto-Generated React Query Client

This project uses [Orval](https://orval.dev/) to automatically generate a type-safe React Query client from the NestJS backend's OpenAPI specification.

**Note**: This application **only runs with Docker Compose**. API client generation happens automatically on container startup.

## 📋 Overview

The setup follows this flow:
```
NestJS Backend → OpenAPI Spec → Orval → React Query Client
```

When you run `docker-compose up`:
1. Backend starts and generates OpenAPI spec
2. Frontend container mounts the OpenAPI spec
3. Frontend generates React Query client on startup
4. Frontend serves the application

## 🎯 Features

✅ **Type-safe API client** - Fully typed requests and responses  
✅ **React Query hooks** - Ready-to-use hooks for data fetching  
✅ **Automatic generation** - Client regenerates on every Docker startup  
✅ **Committed to git** - Generated code is part of the repository  
✅ **OpenAPI compliant** - Based on Swagger/OpenAPI 3.0 specification  
✅ **Docker-only** - Simplified setup, no local dev complexity  

## 📁 Project Structure

```
/workspace
├── backend/
│   ├── src/
│   │   ├── contracts/
│   │   │   ├── contracts.controller.ts      # API endpoints with @ApiTags decorators
│   │   │   ├── contracts.service.ts         # Service with proper return types
│   │   │   └── dto/
│   │   │       └── contract-response.dto.ts # DTO with @ApiProperty decorators
│   │   ├── main.ts                          # Swagger setup
│   │   └── generate-openapi.ts              # Script to export OpenAPI spec
│   └── openapi.json                         # Generated OpenAPI specification
│
├── frontend/
│   ├── src/
│   │   ├── api/
│   │   │   ├── axios-instance.ts            # Custom Axios instance
│   │   │   └── generated/                   # 🎯 Auto-generated by Orval
│   │   │       ├── contracts/
│   │   │       │   └── contracts.ts         # React Query hooks
│   │   │       └── model/
│   │   │           ├── contractFileDto.ts   # TypeScript types
│   │   │           └── ...
│   │   ├── App.tsx                          # Example usage
│   │   └── main.tsx                         # React Query provider setup
│   └── orval.config.ts                      # Orval configuration
│
└── scripts/
    └── generate-api-client.sh               # Helper script
```

## 🚀 How to Use

### Starting the Application

The application **only runs with Docker Compose**:

```bash
# Start all services (backend, frontend, database)
docker-compose up

# The system will automatically:
# 1. Start Neo4j database
# 2. Start NestJS backend (generates OpenAPI spec)
# 3. Start frontend container which:
#    - Generates the API client from backend's OpenAPI spec
#    - Starts the Vite dev server
```

### Stopping the Application

```bash
# Stop all services
docker-compose down

# Stop and remove volumes (fresh start)
docker-compose down -v
```

### When Backend API Changes

When you modify backend API endpoints:

1. Restart the Docker containers:
   ```bash
   docker-compose restart
   ```

2. Or rebuild if you changed dependencies:
   ```bash
   docker-compose up --build
   ```

The frontend will automatically regenerate the API client with your changes!

### Using the Generated Client

#### 1. Import the Hook

```typescript
import { useContractsControllerGetAllContracts } from './api/generated/contracts/contracts'
```

#### 2. Use in Your Component

```typescript
function MyComponent() {
  const { data, isLoading, error } = useContractsControllerGetAllContracts()
  
  if (isLoading) return <div>Loading...</div>
  if (error) return <div>Error: {error.message}</div>
  
  return (
    <div>
      {data?.map(contract => (
        <div key={contract.fileName}>
          {contract.fileName}: {contract.content.id}
        </div>
      ))}
    </div>
  )
}
```

#### 3. TypeScript Autocomplete

All types are automatically inferred! You get full IDE autocomplete for:
- Query parameters
- Request bodies
- Response data
- Error types

## 🔧 Configuration Files

### Backend: `src/main.ts`

Swagger is configured to expose the OpenAPI spec:

```typescript
const config = new DocumentBuilder()
  .setTitle("AI Contracts System API")
  .setDescription("API for managing and validating technical dependency contracts")
  .setVersion("1.0")
  .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup("api", app, document);
```

### Backend: DTOs with Decorators

```typescript
import { ApiProperty } from "@nestjs/swagger";

export class ContractFileDto {
  @ApiProperty({
    description: "The name of the contract file",
    example: "example-contract.yml",
  })
  fileName: string;

  @ApiProperty({
    description: "The parsed contract content",
    type: "object",
  })
  content: Contract;
}
```

### Frontend: `orval.config.ts`

```typescript
import { defineConfig } from "orval";

export default defineConfig({
  "ai-contracts-api": {
    input: {
      target: "../backend/openapi.json",  // OpenAPI spec location
    },
    output: {
      mode: "tags-split",                 // Split by @ApiTags
      target: "./src/api/generated",      // Output directory
      client: "react-query",              // Generate React Query hooks
      httpClient: "axios",                // Use Axios
      baseUrl: "http://localhost:3000",   // Default API URL
      override: {
        mutator: {
          path: "./src/api/axios-instance.ts",
          name: "customAxiosInstance",
        },
      },
    },
  },
});
```

## 📦 Generated Files

Orval generates several files:

### Hooks (in `generated/contracts/contracts.ts`)

- `useContractsControllerGetAllContracts()` - React Query hook for GET /contracts
- `useContractsControllerValidateContracts()` - React Query hook for GET /contracts/validate

### Types (in `generated/model/`)

- `ContractFileDto` - Response type
- `ContractFileDtoContent` - Nested contract content type

### Query Options

Each hook also exports:
- `getContractsControllerGetAllContractsQueryKey()` - Query key factory
- `getContractsControllerGetAllContractsQueryOptions()` - Query options factory

## 🎨 Customization

### Changing the Base URL

By default, the client uses `http://localhost:3000`. To change this:

1. Set the `VITE_API_URL` environment variable:
   ```bash
   VITE_API_URL=https://api.example.com
   ```

2. Or modify `frontend/src/api/axios-instance.ts`

### Adding Request Interceptors

Modify `frontend/src/api/axios-instance.ts`:

```typescript
export const AXIOS_INSTANCE = axios.create({
  baseURL: getApiUrl(),
});

AXIOS_INSTANCE.interceptors.request.use((config) => {
  // Add auth token
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

## 🚨 Important Notes

1. **Docker Compose only** - This application only runs with Docker Compose
2. **Generated files are committed to git** - This ensures everyone on the team has the same client
3. **Don't manually edit generated files** - They will be overwritten on regeneration
4. **Auto-regenerates on startup** - Frontend container regenerates API client every time it starts
5. **OpenAPI spec must be valid** - Invalid specs will cause frontend container to fail startup

## 🔍 Troubleshooting

### Frontend container fails to start

Check the logs:
```bash
docker logs ai-contracts-frontend
```

Look for API generation errors. If the OpenAPI spec is missing or invalid, the frontend will fail to start.

### Type errors after API changes

Rebuild the containers:
```bash
docker-compose up --build
```

### API client seems outdated

Restart the frontend container:
```bash
docker-compose restart frontend
```

The API client will regenerate with the latest backend changes.

## 📚 Resources

- [Orval Documentation](https://orval.dev/)
- [React Query Documentation](https://tanstack.com/query/latest)
- [NestJS Swagger Documentation](https://docs.nestjs.com/openapi/introduction)
