# Orval Setup - Auto-Generated React Query Client

This project uses [Orval](https://orval.dev/) to automatically generate a type-safe React Query client from the NestJS backend's OpenAPI specification.

## 📋 Overview

The setup follows this flow:
```
NestJS Backend → OpenAPI Spec → Orval → React Query Client
```

## 🎯 Features

✅ **Type-safe API client** - Fully typed requests and responses  
✅ **React Query hooks** - Ready-to-use hooks for data fetching  
✅ **Automatic generation** - Client regenerates when API changes  
✅ **Committed to git** - Generated code is part of the repository  
✅ **OpenAPI compliant** - Based on Swagger/OpenAPI 3.0 specification  

## 📁 Project Structure

```
/workspace
├── backend/
│   ├── src/
│   │   ├── contracts/
│   │   │   ├── contracts.controller.ts      # API endpoints with @ApiTags decorators
│   │   │   ├── contracts.service.ts         # Service with proper return types
│   │   │   └── dto/
│   │   │       └── contract-response.dto.ts # DTO with @ApiProperty decorators
│   │   ├── main.ts                          # Swagger setup
│   │   └── generate-openapi.ts              # Script to export OpenAPI spec
│   └── openapi.json                         # Generated OpenAPI specification
│
├── frontend/
│   ├── src/
│   │   ├── api/
│   │   │   ├── axios-instance.ts            # Custom Axios instance
│   │   │   └── generated/                   # 🎯 Auto-generated by Orval
│   │   │       ├── contracts/
│   │   │       │   └── contracts.ts         # React Query hooks
│   │   │       └── model/
│   │   │           ├── contractFileDto.ts   # TypeScript types
│   │   │           └── ...
│   │   ├── App.tsx                          # Example usage
│   │   └── main.tsx                         # React Query provider setup
│   └── orval.config.ts                      # Orval configuration
│
└── scripts/
    └── generate-api-client.sh               # Helper script
```

## 🚀 How to Use

### Initial Setup

The setup is already complete! But if you need to regenerate everything:

```bash
# Install dependencies
cd backend && npm install
cd ../frontend && npm install

# Generate OpenAPI spec from backend
cd backend
npm run generate:openapi

# Generate React Query client
cd ../frontend
npm run generate:api
```

### Development Workflow

#### Starting Development with Docker Compose

When using Docker Compose, the API client is **automatically generated once at startup**:

```bash
# Start all services (backend, frontend, database)
docker-compose up

# The frontend container will:
# 1. Generate the API client from backend's OpenAPI spec
# 2. Start the Vite dev server
```

#### Starting Development Locally (without Docker)

```bash
# Terminal 1: Start backend (generates OpenAPI spec)
cd backend
npm run start:dev

# Terminal 2: Generate API client, then start frontend
cd frontend
npm run generate:api  # Run once after backend API changes
npm run dev
```

#### Manual Regeneration

If you need to manually regenerate the client during local development:

```bash
# From backend: Generate new OpenAPI spec
cd backend
npm run generate:openapi

# From frontend: Regenerate React Query client
cd frontend
npm run generate:api

# Or use the helper script from root
npm run generate:api
```

#### When to Regenerate

For **Docker deployments**: API client regenerates automatically on container startup.

For **local development**: Manually regenerate when you:
- ✏️ Add new API endpoints
- ✏️ Modify existing endpoints
- ✏️ Change request/response DTOs
- ✏️ Update API documentation

### Using the Generated Client

#### 1. Import the Hook

```typescript
import { useContractsControllerGetAllContracts } from './api/generated/contracts/contracts'
```

#### 2. Use in Your Component

```typescript
function MyComponent() {
  const { data, isLoading, error } = useContractsControllerGetAllContracts()
  
  if (isLoading) return <div>Loading...</div>
  if (error) return <div>Error: {error.message}</div>
  
  return (
    <div>
      {data?.map(contract => (
        <div key={contract.fileName}>
          {contract.fileName}: {contract.content.id}
        </div>
      ))}
    </div>
  )
}
```

#### 3. TypeScript Autocomplete

All types are automatically inferred! You get full IDE autocomplete for:
- Query parameters
- Request bodies
- Response data
- Error types

## 🔧 Configuration Files

### Backend: `src/main.ts`

Swagger is configured to expose the OpenAPI spec:

```typescript
const config = new DocumentBuilder()
  .setTitle("AI Contracts System API")
  .setDescription("API for managing and validating technical dependency contracts")
  .setVersion("1.0")
  .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup("api", app, document);
```

### Backend: DTOs with Decorators

```typescript
import { ApiProperty } from "@nestjs/swagger";

export class ContractFileDto {
  @ApiProperty({
    description: "The name of the contract file",
    example: "example-contract.yml",
  })
  fileName: string;

  @ApiProperty({
    description: "The parsed contract content",
    type: "object",
  })
  content: Contract;
}
```

### Frontend: `orval.config.ts`

```typescript
import { defineConfig } from "orval";

export default defineConfig({
  "ai-contracts-api": {
    input: {
      target: "../backend/openapi.json",  // OpenAPI spec location
    },
    output: {
      mode: "tags-split",                 // Split by @ApiTags
      target: "./src/api/generated",      // Output directory
      client: "react-query",              // Generate React Query hooks
      httpClient: "axios",                // Use Axios
      baseUrl: "http://localhost:3000",   // Default API URL
      override: {
        mutator: {
          path: "./src/api/axios-instance.ts",
          name: "customAxiosInstance",
        },
      },
    },
  },
});
```

## 📦 Generated Files

Orval generates several files:

### Hooks (in `generated/contracts/contracts.ts`)

- `useContractsControllerGetAllContracts()` - React Query hook for GET /contracts
- `useContractsControllerValidateContracts()` - React Query hook for GET /contracts/validate

### Types (in `generated/model/`)

- `ContractFileDto` - Response type
- `ContractFileDtoContent` - Nested contract content type

### Query Options

Each hook also exports:
- `getContractsControllerGetAllContractsQueryKey()` - Query key factory
- `getContractsControllerGetAllContractsQueryOptions()` - Query options factory

## 🎨 Customization

### Changing the Base URL

By default, the client uses `http://localhost:3000`. To change this:

1. Set the `VITE_API_URL` environment variable:
   ```bash
   VITE_API_URL=https://api.example.com
   ```

2. Or modify `frontend/src/api/axios-instance.ts`

### Adding Request Interceptors

Modify `frontend/src/api/axios-instance.ts`:

```typescript
export const AXIOS_INSTANCE = axios.create({
  baseURL: getApiUrl(),
});

AXIOS_INSTANCE.interceptors.request.use((config) => {
  // Add auth token
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

## 🚨 Important Notes

1. **Generated files are committed to git** - This ensures everyone on the team has the same client
2. **Don't manually edit generated files** - They will be overwritten on regeneration
3. **Docker auto-regenerates** - Frontend container regenerates API client on startup
4. **Local dev requires manual regeneration** - Run `npm run generate:api` after backend API changes
5. **OpenAPI spec must be valid** - Invalid specs will cause generation to fail

## 🔍 Troubleshooting

### "Module not found" errors

```bash
# Regenerate the client
cd frontend
npm run generate:api
```

### Type errors after API changes

1. Regenerate OpenAPI spec: `cd backend && npm run generate:openapi`
2. Regenerate client: `cd frontend && npm run generate:api`
3. Restart your dev server

### OpenAPI spec is outdated

Make sure you regenerate the spec after backend changes:
```bash
cd backend
npm run generate:openapi
```

## 📚 Resources

- [Orval Documentation](https://orval.dev/)
- [React Query Documentation](https://tanstack.com/query/latest)
- [NestJS Swagger Documentation](https://docs.nestjs.com/openapi/introduction)
